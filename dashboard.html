<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard B2B Mobilis - R√©gion Ouest</title>
    <script>
        if (sessionStorage.getItem('dashboard_auth') !== 'true') {
            window.location.href = 'index.html';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CSS & JS pour la carte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .logo-text span {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .month-selector label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .month-selector select {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0.25rem;
        }

        .month-selector select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .header-info {
            text-align: right;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .header-info .date {
            color: var(--text-primary);
            font-weight: 500;
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.15);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .kpi-title {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .kpi-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .kpi-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .kpi-change.positive {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .kpi-change.neutral {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .kpi-change.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .team-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .team-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .team-table th {
            text-align: left;
            padding: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
        }

        .team-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .team-table tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .commercial-name {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-ok {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .status-attention {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .status-critical {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            width: 80px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Section carte */
        .map-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .map-section {
                grid-template-columns: 1fr;
            }
        }

        #algeriaMap {
            height: 400px;
            border-radius: 12px;
            z-index: 1;
        }

        .map-legend {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .wilaya-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .wilaya-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            transition: background 0.2s;
        }

        .wilaya-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .wilaya-name {
            font-weight: 500;
        }

        .wilaya-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }

        .wilaya-stats span {
            color: var(--text-secondary);
        }

        .wilaya-stats strong {
            color: var(--text-primary);
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .kpi-value {
                font-size: 1.5rem;
            }

            #algeriaMap {
                height: 300px;
            }
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Leaflet popup custom */
        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .leaflet-popup-tip {
            background: var(--bg-card);
        }

        .popup-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--accent-light);
        }

        .popup-stat {
            display: flex;
            justify-content: space-between;
            margin: 0.25rem 0;
            font-size: 0.875rem;
        }

        .popup-stat span {
            color: var(--text-secondary);
        }

        .popup-stat strong {
            color: var(--text-primary);
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">M</div>
            <div class="logo-text">
                <h1>Mobilis B2B</h1>
                <span>Dashboard Commercial - R√©gion Ouest</span>
            </div>
        </div>

        <div class="controls">
            <div class="month-selector">
                <label>üìÖ P√©riode :</label>
                <select id="monthSelect" onchange="updateDashboard()">
                    <option value="all">Toute l'ann√©e 2026</option>
                    <option value="01" selected>Janvier 2026</option>
                    <option value="02">F√©vrier 2026</option>
                    <option value="03">Mars 2026</option>
                    <option value="04">Avril 2026</option>
                    <option value="05">Mai 2026</option>
                    <option value="06">Juin 2026</option>
                    <option value="07">Juillet 2026</option>
                    <option value="08">Ao√ªt 2026</option>
                    <option value="09">Septembre 2026</option>
                    <option value="10">Octobre 2026</option>
                    <option value="11">Novembre 2026</option>
                    <option value="12">D√©cembre 2026</option>
                </select>
            </div>
        </div>

        <div class="header-info">
            <div>Manager: <strong>Brahim BOUDRAA</strong></div>
            <div class="date" id="currentDate"></div>
            <button class="btn-logout" onclick="logout()">üö™ D√©connexion</button>
        </div>
    </header>

    <div class="container">
        <!-- KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card animate-in">
                <div class="kpi-header">
                    <span class="kpi-title">Chiffre d'Affaires</span>
                    <div class="kpi-icon" style="background: rgba(34, 197, 94, 0.15);">üí∞</div>
                </div>
                <div class="kpi-value" id="totalCA">--</div>
                <span class="kpi-change positive" id="caPeriod">Janvier 2026</span>
            </div>
            <div class="kpi-card animate-in">
                <div class="kpi-header">
                    <span class="kpi-title">Objectif CA √âquipe</span>
                    <div class="kpi-icon" style="background: rgba(99, 102, 241, 0.15);">üéØ</div>
                </div>
                <div class="kpi-value" id="objectifCA">880 000 DA</div>
                <span class="kpi-change neutral" id="tauxCA">0%</span>
            </div>
            <div class="kpi-card animate-in">
                <div class="kpi-header">
                    <span class="kpi-title">Visites Terrain</span>
                    <div class="kpi-icon" style="background: rgba(245, 158, 11, 0.15);">üìç</div>
                </div>
                <div class="kpi-value" id="totalVisites">--</div>
                <span class="kpi-change neutral" id="visitesInfo">8 commerciaux</span>
            </div>
            <div class="kpi-card animate-in">
                <div class="kpi-header">
                    <span class="kpi-title">Objectif Prospection</span>
                    <div class="kpi-icon" style="background: rgba(139, 92, 246, 0.15);">üîç</div>
                </div>
                <div class="kpi-value" id="objectifProsp">320</div>
                <span class="kpi-change neutral" id="tauxProsp">0%</span>
            </div>
            <div class="kpi-card animate-in">
                <div class="kpi-header">
                    <span class="kpi-title">Wilayas Couvertes</span>
                    <div class="kpi-icon" style="background: rgba(6, 182, 212, 0.15);">üó∫Ô∏è</div>
                </div>
                <div class="kpi-value" id="totalWilayas">--</div>
                <span class="kpi-change positive">R√©gion Ouest</span>
            </div>
            <div class="kpi-card animate-in">
                <div class="kpi-header">
                    <span class="kpi-title">CA / Visite</span>
                    <div class="kpi-icon" style="background: rgba(236, 72, 153, 0.15);">üìä</div>
                </div>
                <div class="kpi-value" id="caParVisite">--</div>
                <span class="kpi-change neutral">Productivit√©</span>
            </div>
        </div>

        <!-- Carte Alg√©rie Ouest -->
        <div class="map-section">
            <div class="chart-card animate-in">
                <h3 class="chart-title">üó∫Ô∏è Carte Interactive - R√©gion Ouest Alg√©rie</h3>
                <div id="algeriaMap"></div>
                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-circle" style="background: #22c55e;"></div>
                        <span>CA √©lev√© (>50K DA)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="background: #f59e0b;"></div>
                        <span>CA moyen (10K-50K DA)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="background: #ef4444;"></div>
                        <span>CA faible (<10K DA)</span>
                    </div>
                    <div class="legend-item">
                        <span>üí° Taille = Nombre de visites</span>
                    </div>
                </div>
            </div>
            <div class="chart-card animate-in">
                <h3 class="chart-title">üìç D√©tail par Wilaya</h3>
                <div class="wilaya-list" id="wilayaList"></div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="charts-grid">
            <div class="chart-card animate-in">
                <h3 class="chart-title">üìà Performance CA par Commercial</h3>
                <div class="chart-container"><canvas id="performanceChart"></canvas></div>
            </div>
            <div class="chart-card animate-in">
                <h3 class="chart-title">ü•ß R√©partition du CA</h3>
                <div class="chart-container"><canvas id="caChart"></canvas></div>
            </div>
        </div>

        <!-- Tableau √©quipe -->
        <div class="team-section animate-in">
            <h3 class="chart-title">üë• Performance √âquipe (Objectifs CA: 110 000 DA | Prospection: 40 visites)</h3>
            <table class="team-table">
                <thead>
                    <tr>
                        <th>Commercial</th>
                        <th>Wilaya</th>
                        <th>Visites</th>
                        <th>Prospection</th>
                        <th>CA R√©alis√©</th>
                        <th>Obj. CA</th>
                        <th>Obj. Prosp.</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody id="teamTableBody"></tbody>
            </table>
        </div>
    </div>

    <footer class="footer">
        <p>Dashboard B2B Mobilis - Manager Ouest | Brahim BOUDRAA</p>
        <p>Donn√©es mises √† jour chaque semaine ‚Ä¢ ¬© 2026</p>
    </footer>

    <script>
        // ============================================
        // COORDONN√âES DES WILAYAS - OUEST ALG√âRIEN
        // ============================================
        const WILAYAS_COORDS = {
            'ORAN': { lat: 35.6969, lng: -0.6331, code: 31 },
            'TLEMCEN': { lat: 34.8828, lng: -1.3167, code: 13 },
            'AIN TEMOUCHENT': { lat: 35.2974, lng: -1.1400, code: 46 },
            'SIDI BEL ABBES': { lat: 35.1904, lng: -0.6306, code: 22 },
            'MOSTAGANEM': { lat: 35.9311, lng: 0.0892, code: 27 },
            'MASCARA': { lat: 35.4000, lng: 0.1403, code: 29 },
            'RELIZANE': { lat: 35.7372, lng: 0.5567, code: 48 },
            'TIARET': { lat: 35.3711, lng: 1.3172, code: 14 },
            'SAIDA': { lat: 34.8303, lng: 0.1517, code: 20 },
            'NAAMA': { lat: 33.2667, lng: -0.3117, code: 45 },
            'EL BAYADH': { lat: 33.6833, lng: 1.0167, code: 32 },
            'BECHAR': { lat: 31.6167, lng: -2.2167, code: 8 },
            'ADRAR': { lat: 27.8742, lng: -0.2939, code: 1 },
            'TINDOUF': { lat: 27.6744, lng: -8.1478, code: 37 },
            'DJELFA': { lat: 34.6704, lng: 3.2503, code: 17 },
            'MEDEA': { lat: 36.2675, lng: 2.7500, code: 26 },
            'CHLEF': { lat: 36.1647, lng: 1.3317, code: 2 }
        };

        // ============================================
        // DONN√âES PAR MOIS
        // ============================================
        const DATA_PAR_MOIS = {
            '01': {
                summary: { totalCA: 307480, totalVisites: 167, totalProspection: 73, totalWilayas: 8 },
                commerciaux: [
                    { nom: "HICHEM KHOUDRIA", wilaya: "MEDEA", visites: 26, prospection: 20, ca: 95000, objectifCA: 110000, objectifProsp: 40, initiales: "HK" },
                    { nom: "SABRINA BARKAT", wilaya: "AIN TEMOUCHENT", visites: 39, prospection: 6, ca: 94500, objectifCA: 110000, objectifProsp: 40, initiales: "SB" },
                    { nom: "HANKOUR AMINE", wilaya: "ORAN", visites: 14, prospection: 1, ca: 53980, objectifCA: 110000, objectifProsp: 40, initiales: "HA" },
                    { nom: "NADJAT AISSOU", wilaya: "MOSTAGANEM", visites: 16, prospection: 5, ca: 37000, objectifCA: 110000, objectifProsp: 40, initiales: "NA" },
                    { nom: "BELBALI SLYMAN", wilaya: "ADRAR", visites: 3, prospection: 1, ca: 11500, objectifCA: 110000, objectifProsp: 40, initiales: "BS" },
                    { nom: "YASMINA TAIBI", wilaya: "SIDI BEL ABBES", visites: 23, prospection: 15, ca: 9000, objectifCA: 110000, objectifProsp: 40, initiales: "YT" },
                    { nom: "BEKKAL-BRIKCI", wilaya: "TLEMCEN", visites: 29, prospection: 24, ca: 6500, objectifCA: 110000, objectifProsp: 40, initiales: "BB" },
                    { nom: "AISSA DAHMOUNE", wilaya: "DJELFA", visites: 17, prospection: 1, ca: 0, objectifCA: 110000, objectifProsp: 40, initiales: "AD" }
                ],
                wilayas: [
                    { nom: "AIN TEMOUCHENT", visites: 39, ca: 94500 },
                    { nom: "TLEMCEN", visites: 29, ca: 6500 },
                    { nom: "MEDEA", visites: 26, ca: 95000 },
                    { nom: "SIDI BEL ABBES", visites: 23, ca: 9000 },
                    { nom: "DJELFA", visites: 17, ca: 0 },
                    { nom: "MOSTAGANEM", visites: 16, ca: 37000 },
                    { nom: "ORAN", visites: 14, ca: 53980 },
                    { nom: "ADRAR", visites: 3, ca: 11500 }
                ]
            },
            '02': {
                summary: { totalCA: 5480, totalVisites: 1, totalProspection: 0, totalWilayas: 1 },
                commerciaux: [
                    { nom: "HANKOUR AMINE", wilaya: "ORAN", visites: 1, prospection: 0, ca: 5480, objectifCA: 110000, objectifProsp: 40, initiales: "HA" }
                ],
                wilayas: [
                    { nom: "ORAN", visites: 1, ca: 5480 }
                ]
            },
            '03': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '04': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '05': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '06': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '07': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '08': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '09': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '10': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '11': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] },
            '12': { summary: { totalCA: 0, totalVisites: 0, totalProspection: 0, totalWilayas: 0 }, commerciaux: [], wilayas: [] }
        };

        const MOIS_NOMS = {
            '01': 'Janvier', '02': 'F√©vrier', '03': 'Mars', '04': 'Avril',
            '05': 'Mai', '06': 'Juin', '07': 'Juillet', '08': 'Ao√ªt',
            '09': 'Septembre', '10': 'Octobre', '11': 'Novembre', '12': 'D√©cembre'
        };

        let performanceChart, caChart, map, markersLayer;

        function formatDA(num) {
            return new Intl.NumberFormat('fr-DZ').format(num) + ' DA';
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num.toString();
        }

        function getCurrentData() {
            const mois = document.getElementById('monthSelect').value;
            if (mois === 'all') {
                let totalCA = 0, totalVisites = 0, totalProspection = 0;
                const commerciauxMap = {}, wilayasMap = {};

                Object.values(DATA_PAR_MOIS).forEach(data => {
                    totalCA += data.summary.totalCA;
                    totalVisites += data.summary.totalVisites;
                    totalProspection += data.summary.totalProspection || 0;
                    data.commerciaux.forEach(c => {
                        if (!commerciauxMap[c.nom]) commerciauxMap[c.nom] = { ...c, visites: 0, prospection: 0, ca: 0 };
                        commerciauxMap[c.nom].visites += c.visites;
                        commerciauxMap[c.nom].prospection += c.prospection || 0;
                        commerciauxMap[c.nom].ca += c.ca;
                    });
                    data.wilayas.forEach(w => {
                        if (!wilayasMap[w.nom]) wilayasMap[w.nom] = { ...w, visites: 0, ca: 0 };
                        wilayasMap[w.nom].visites += w.visites;
                        wilayasMap[w.nom].ca += w.ca;
                    });
                });

                return {
                    summary: { totalCA, totalVisites, totalProspection, totalWilayas: Object.keys(wilayasMap).length },
                    commerciaux: Object.values(commerciauxMap).sort((a, b) => b.ca - a.ca),
                    wilayas: Object.values(wilayasMap).sort((a, b) => b.visites - a.visites)
                };
            }
            return DATA_PAR_MOIS[mois] || DATA_PAR_MOIS['01'];
        }

        // ============================================
        // CARTE INTERACTIVE
        // ============================================
        function initMap() {
            // Centrer sur l'Ouest alg√©rien
            map = L.map('algeriaMap', {
                center: [33.5, -0.5],
                zoom: 5,
                zoomControl: true,
                scrollWheelZoom: true
            });

            // Tuiles style sombre
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
        }

        function updateMap(data) {
            if (!map || !markersLayer) return;

            markersLayer.clearLayers();

            if (data.wilayas.length === 0) return;

            // Trouver le CA max pour normaliser
            const maxCA = Math.max(...data.wilayas.map(w => w.ca), 1);
            const maxVisites = Math.max(...data.wilayas.map(w => w.visites), 1);

            data.wilayas.forEach(wilaya => {
                const coords = WILAYAS_COORDS[wilaya.nom];
                if (!coords) return;

                // Taille du cercle bas√©e sur les visites (min 15, max 50)
                const radius = 15 + (wilaya.visites / maxVisites) * 35;

                // Couleur bas√©e sur le CA
                let color;
                if (wilaya.ca >= 50000) {
                    color = '#22c55e'; // Vert - CA √©lev√©
                } else if (wilaya.ca >= 10000) {
                    color = '#f59e0b'; // Orange - CA moyen
                } else {
                    color = '#ef4444'; // Rouge - CA faible
                }

                // Cr√©er le cercle
                const circle = L.circleMarker([coords.lat, coords.lng], {
                    radius: radius,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.7
                });

                // Popup avec infos
                const popupContent = `
                    <div style="min-width: 180px;">
                        <div class="popup-title">${wilaya.nom}</div>
                        <div class="popup-stat"><span>CA R√©alis√©:</span> <strong>${formatDA(wilaya.ca)}</strong></div>
                        <div class="popup-stat"><span>Visites:</span> <strong>${wilaya.visites}</strong></div>
                    </div>
                `;
                circle.bindPopup(popupContent);

                // Tooltip au survol
                circle.bindTooltip(wilaya.nom, {
                    permanent: false,
                    direction: 'top',
                    className: 'wilaya-tooltip'
                });

                markersLayer.addLayer(circle);
            });

            // Ajuster la vue pour englober tous les marqueurs
            if (markersLayer.getLayers().length > 0) {
                const group = new L.featureGroup(markersLayer.getLayers());
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }

        function updateKPIs(data) {
            const mois = document.getElementById('monthSelect').value;
            const periode = mois === 'all' ? 'Ann√©e 2026' : MOIS_NOMS[mois] + ' 2026';
            const nbCommerciaux = data.commerciaux.length || 8;

            const objectifCAEquipe = nbCommerciaux * 110000;
            const objectifProspEquipe = nbCommerciaux * 40;

            document.getElementById('totalCA').textContent = formatDA(data.summary.totalCA);
            document.getElementById('totalVisites').textContent = data.summary.totalVisites;
            document.getElementById('totalWilayas').textContent = data.summary.totalWilayas;
            document.getElementById('caPeriod').textContent = periode;

            document.getElementById('objectifCA').textContent = formatDA(objectifCAEquipe);
            document.getElementById('objectifProsp').textContent = objectifProspEquipe;

            const tauxCA = objectifCAEquipe > 0 ? Math.round((data.summary.totalCA / objectifCAEquipe) * 100) : 0;
            const tauxProsp = objectifProspEquipe > 0 ? Math.round(((data.summary.totalProspection || 0) / objectifProspEquipe) * 100) : 0;

            document.getElementById('tauxCA').textContent = tauxCA + '% atteint';
            document.getElementById('tauxCA').className = 'kpi-change ' + (tauxCA >= 80 ? 'positive' : tauxCA >= 50 ? 'neutral' : 'negative');

            document.getElementById('tauxProsp').textContent = tauxProsp + '% atteint';
            document.getElementById('tauxProsp').className = 'kpi-change ' + (tauxProsp >= 80 ? 'positive' : tauxProsp >= 50 ? 'neutral' : 'negative');

            const caParVisite = data.summary.totalVisites > 0 ? Math.round(data.summary.totalCA / data.summary.totalVisites) : 0;
            document.getElementById('caParVisite').textContent = formatDA(caParVisite);
        }

        function createPerformanceChart(data) {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            if (performanceChart) performanceChart.destroy();

            if (data.commerciaux.length === 0) {
                ctx.parentElement.innerHTML = '<div class="no-data"><div class="no-data-icon">üìä</div><p>Pas de donn√©es</p></div>';
                return;
            }

            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.commerciaux.map(c => c.nom.split(' ').pop()),
                    datasets: [
                        { label: 'CA R√©alis√©', data: data.commerciaux.map(c => c.ca), backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 8 },
                        { label: 'Objectif CA', data: data.commerciaux.map(c => c.objectifCA), backgroundColor: 'rgba(255, 255, 255, 0.15)', borderRadius: 8 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#a1a1aa' } } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a1a1aa' } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a1a1aa', callback: v => formatNumber(v) } }
                    }
                }
            });
        }

        function createCAChart(data) {
            const ctx = document.getElementById('caChart');
            if (!ctx) return;

            if (caChart) caChart.destroy();

            const filtered = data.commerciaux.filter(c => c.ca > 0);
            if (filtered.length === 0) {
                ctx.parentElement.innerHTML = '<div class="no-data"><div class="no-data-icon">ü•ß</div><p>Pas de CA</p></div>';
                return;
            }

            caChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: filtered.map(c => c.nom.split(' ').pop()),
                    datasets: [{
                        data: filtered.map(c => c.ca),
                        backgroundColor: ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#a1a1aa', padding: 15, usePointStyle: true } } },
                    cutout: '65%'
                }
            });
        }

        function createTeamTable(data) {
            const tbody = document.getElementById('teamTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (data.commerciaux.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Pas de donn√©es pour cette p√©riode</td></tr>';
                return;
            }

            data.commerciaux.forEach(c => {
                const progressCA = Math.min(100, Math.round((c.ca / c.objectifCA) * 100));
                const progressProsp = Math.min(100, Math.round(((c.prospection || 0) / c.objectifProsp) * 100));

                let statusClass = 'status-ok', statusText = 'En bonne voie';
                let progressColorCA = '#22c55e', progressColorProsp = '#22c55e';

                if (progressCA < 30) { statusClass = 'status-critical'; statusText = 'Critique'; progressColorCA = '#ef4444'; }
                else if (progressCA < 70) { statusClass = 'status-attention'; statusText = 'Attention'; progressColorCA = '#f59e0b'; }

                if (progressProsp < 30) progressColorProsp = '#ef4444';
                else if (progressProsp < 70) progressColorProsp = '#f59e0b';

                tbody.innerHTML += `
                    <tr>
                        <td><div class="commercial-name"><div class="avatar">${c.initiales}</div><span>${c.nom}</span></div></td>
                        <td>${c.wilaya}</td>
                        <td><strong>${c.visites}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <strong>${c.prospection || 0}</strong>
                                <div class="progress-bar"><div class="progress-fill" style="width: ${progressProsp}%; background: ${progressColorProsp};"></div></div>
                                <span style="font-size: 0.7rem; color: var(--text-secondary);">${progressProsp}%</span>
                            </div>
                        </td>
                        <td><strong>${formatDA(c.ca)}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="progress-bar"><div class="progress-fill" style="width: ${progressCA}%; background: ${progressColorCA};"></div></div>
                                <span style="font-size: 0.7rem; color: var(--text-secondary);">${progressCA}%</span>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="progress-bar"><div class="progress-fill" style="width: ${progressProsp}%; background: ${progressColorProsp};"></div></div>
                                <span style="font-size: 0.7rem; color: var(--text-secondary);">${progressProsp}%</span>
                            </div>
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });
        }

        function createWilayaList(data) {
            const list = document.getElementById('wilayaList');
            if (!list) return;
            list.innerHTML = '';

            if (data.wilayas.length === 0) {
                list.innerHTML = '<div class="no-data">Pas de donn√©es</div>';
                return;
            }

            const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#10b981'];
            data.wilayas.forEach((w, i) => {
                const color = w.ca >= 50000 ? '#22c55e' : w.ca >= 10000 ? '#f59e0b' : '#ef4444';
                list.innerHTML += `
                    <div class="wilaya-item">
                        <div class="wilaya-name"><span style="color: ${color}; font-size: 1.5rem;">‚óè</span> ${w.nom}</div>
                        <div class="wilaya-stats">
                            <span>üìç <strong>${w.visites}</strong> visites</span>
                            <span>üí∞ <strong>${formatDA(w.ca)}</strong></span>
                        </div>
                    </div>
                `;
            });
        }

        function updateDashboard() {
            const data = getCurrentData();
            updateKPIs(data);
            updateMap(data);
            createPerformanceChart(data);
            createCAChart(data);
            createTeamTable(data);
            createWilayaList(data);
        }

        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fr-FR', options);
        }

        function logout() {
            sessionStorage.removeItem('dashboard_auth');
            sessionStorage.removeItem('dashboard_user');
            window.location.href = 'index.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateDate();
            initMap();
            updateDashboard();
        });
    </script>
</body>

</html>